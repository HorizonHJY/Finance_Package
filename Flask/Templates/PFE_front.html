<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Curve Root Selector</title>
  <link rel="stylesheet"
        href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css">
  <style>
    .delete-row, .duplicate-row { margin-top: .5rem; margin-right: .5rem; }
    .direction-group { display: flex; gap: 1rem; }
    .clear-btn {
      cursor: pointer;
      padding: 0 10px;
      background: transparent;
      border: 1px solid #ced4da;
      border-left: none;
    }
    .clear-btn:hover { background: #f8f9fa; }
    .input-group-append { margin-left: -1px; }
  </style>
</head>
<body>
  <div class="container mt-5">
    <h2>Select Commodity, Destination & Deliver Date</h2>
    <datalist id="commodities-list">
      {% for c in commodities %}
        <option value="{{ c }}">
      {% endfor %}
    </datalist>

    <form id="pfe-form">
      <table class="table table-bordered" id="selection-table">
        <thead>
          <tr>
            <th>Commodity</th>
            <th>Destination</th>
            <th>Direction</th>
            <th>Deliver Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr class="selection-row">
            <td>
              <div class="input-group">
                <input type="text" name="commodity[]" list="commodities-list"
                       class="form-control commodity-input"
                       placeholder="--Select Commodity--">
                <div class="input-group-append">
                  <button class="clear-btn" type="button">×</button>
                </div>
              </div>
            </td>
            <td>
              <select name="destination[]" class="form-control destination-select">
                <option value="">--Select Destination--</option>
              </select>
            </td>
            <td>
              <div class="direction-group">
                <label><input type="radio" name="direction_0" value="Buy" checked> Buy</label>
                <label><input type="radio" name="direction_0" value="Sell"> Sell</label>
              </div>
            </td>
            <td>
              <select name="deliver_date[]" class="form-control deliver-month-select">
                <option value="">--Select Month--</option>
              </select>
            </td>
            <td>
              <button type="button" class="btn btn-secondary btn-sm duplicate-row">Duplicate</button>
              <button type="button" class="btn btn-danger btn-sm delete-row">Delete</button>
            </td>
          </tr>
        </tbody>
      </table>

      <button type="button" id="add-row-btn" class="btn btn-primary">Add Row</button>
      <button type="button" id="fetch-btn"    class="btn btn-success">Get Curve Roots</button>
    </form>

    <div class="mt-3">
      <h5>Results:</h5>
      <div id="results-container"></div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
  $(function(){
    function loadAvailableMonths() {
      fetch('/get_available_months')
        .then(r => r.json())
        .then(months => {
          $('.deliver-month-select').each(function(){
            const $sel = $(this);
            const currentVal = $sel.val();
            $sel.html('<option value="">--Select Month--</option>');
            months.forEach(m => {
              $sel.append(`<option value="${m}">${m}</option>`);
            });
            if(currentVal) {
              $sel.val(currentVal);
            }
          });
        });
    }

    // 页面加载时填充下拉月份
    loadAvailableMonths();

    // Add Row - 添加空白行
    $('#add-row-btn').on('click', function(){
      const $source = $('#selection-table tbody tr.selection-row').first();
      const $clone = $source.clone();
      const newIndex = $('#selection-table tbody tr.selection-row').length;

      // 清空所有输入
      $clone.find('.commodity-input').val('');
      $clone.find('.destination-select').html('<option value="">--Select Destination--</option>');
      $clone.find('.deliver-month-select').val('');

      // 更新radio按钮
      $clone.find('input[type="radio"]').each(function(){
        $(this).attr('name', 'direction_' + newIndex)
               .prop('checked', $(this).val() === 'Buy');
      });

      // 添加到表格
      $('#selection-table tbody').append($clone);

      loadAvailableMonths();
    });

    // Delete Row
    $(document).on('click', '.delete-row', function(){
      if($('#selection-table tbody tr.selection-row').length > 1){
        $(this).closest('tr').remove();
      }
    });

    // Duplicate Row - 复制当前行并保留所有值
    $(document).on('click', '.duplicate-row', function(){
      const $source = $(this).closest('tr');
      const originalComm = $source.find('.commodity-input').val();
      const originalDest = $source.find('.destination-select').val();
      const originalDate = $source.find('.deliver-month-select').val();
      const originalDirection = $source.find('input[type="radio"]:checked').val();

      // 克隆行
      const $clone = $source.clone();
      const newIndex = $('#selection-table tbody tr.selection-row').length;

      // 更新radio按钮的name属性
      $clone.find('input[type="radio"]').each(function(){
        $(this).attr('name', 'direction_' + newIndex);
      });

      // 设置选中的radio按钮
      $clone.find(`input[type="radio"][value="${originalDirection}"]`).prop('checked', true);

      // 添加到表格
      $('#selection-table tbody').append($clone);

      // 设置commodity值
      $clone.find('.commodity-input').val(originalComm);

      // 触发commodity输入事件以加载destination
      if(originalComm) {
        $clone.find('.commodity-input').trigger('input');

        // 设置destination的值
        setTimeout(() => {
          $clone.find('.destination-select').val(originalDest);
        }, 100);
      }

      // 设置deliver date的值
      $clone.find('.deliver-month-select').val(originalDate);

      loadAvailableMonths();
    });

    // Clear input
    $(document).on('click', '.clear-btn', function(){
      const $input = $(this).closest('.input-group').find('.commodity-input');
      $input.val('').trigger('input').focus();
    });

    // Commodity → Destination 级联
    $(document).on('input', '.commodity-input', function(){
      const $row = $(this).closest('tr');
      const comm = $(this).val().trim();
      const $dest = $row.find('.destination-select');
      const currentDest = $dest.val();

      $dest.find('option:not(:first)').remove();
      if(!comm) return;

      fetch('/get_destinations', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({commodity: comm})
      })
      .then(r => r.json())
      .then(destinations => {
        destinations.forEach(d => {
          $dest.append(`<option value="${d}">${d}</option>`);
        });
        // 恢复之前选中的destination
        if(currentDest && destinations.includes(currentDest)) {
          $dest.val(currentDest);
        }
      });
    });

    // Destination → Commodity 验证
    $(document).on('change', '.destination-select', function(){
      const $row = $(this).closest('tr');
      const dest = $(this).val();
      const $comm = $row.find('.commodity-input');
      const currentComm = $comm.val().trim();

      if(!dest || !currentComm) return;

      fetch('/get_commodities', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({destination: dest})
      })
      .then(r => r.json())
      .then(validCommodities => {
        if(!validCommodities.includes(currentComm)) {
          alert("Invalid Commodity-Destination pairing.");
          $comm.val('');
        }
      });
    });

    // Fetch Curve Roots
    $('#fetch-btn').on('click', function(){
      $('#results-container').empty();
      $('#selection-table tbody tr.selection-row').each(function(i,tr){
        const $tr = $(tr);
        const comm = $tr.find('.commodity-input').val();
        const dest = $tr.find('.destination-select').val();
        const dir = $tr.find(`input[name="direction_${i}"]:checked`).val();

        if(comm && dest) {
          fetch('/get_curve_root', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({commodity:comm,destination:dest})
          })
          .then(r=>r.json())
          .then(data=>{
            $('#results-container').append(
              `<p>Row ${i+1}: ${comm}-${dest} → ${data.curve_root} (${dir})</p>`
            );
          });
        }
      });
    });
  });
  </script>
</body>
</html>