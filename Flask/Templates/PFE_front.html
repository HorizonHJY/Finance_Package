<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Curve Root Selector</title>
  <link rel="stylesheet"
        href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css">
  <style>
    .delete-row, .duplicate-row { margin-top: .5rem; margin-right: .5rem; }
    .direction-group { display: flex; gap: 1rem; }
  </style>
</head>
<body>
  <div class="container mt-5">
    <h2>Select Commodity, Destination & Deliver Date</h2>

    <!-- datalist for search -->
    <datalist id="commodities-list">
      {% for c in commodities %}
        <option value="{{ c }}">
      {% endfor %}
    </datalist>

    <form id="pfe-form">
      <table class="table table-bordered" id="selection-table">
        <thead>
          <tr>
            <th>Commodity</th>
            <th>Destination</th>
            <th>Direction</th>
            <th>Deliver Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr class="selection-row">
            <td>
              <input type="text" name="commodity[]" list="commodities-list"
                     class="form-control commodity-input"
                     placeholder="--Select Commodity--">
            </td>
            <td>
              <select name="destination[]" class="form-control destination-select">
                <option value="">--Select Destination--</option>
              </select>
            </td>
            <td>
              <div class="direction-group">
                <label><input type="radio" name="direction_0" value="Buy" checked> Buy</label>
                <label><input type="radio" name="direction_0" value="Sell"> Sell</label>
              </div>
            </td>
            <td>
              <input type="date" name="deliver_date[]" class="form-control">
            </td>
            <td>
              <button type="button" class="btn btn-secondary btn-sm duplicate-row">Duplicate</button>
              <button type="button" class="btn btn-danger btn-sm delete-row">Delete</button>
            </td>
          </tr>
        </tbody>
      </table>

      <button type="button" id="add-row-btn" class="btn btn-primary">Add Row</button>
      <button type="button" id="fetch-btn"    class="btn btn-success">Get Curve Roots</button>
    </form>

    <div class="mt-3">
      <h5>Results:</h5>
      <div id="results-container"></div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
  $(function(){
    // Add Row: clone and reset
    $('#add-row-btn').on('click', function(){
      cloneRow(-1);
    });

    // Delete handler
    $(document).on('click', '.delete-row', function(){
      if($('#selection-table tbody tr.selection-row').length > 1){
        $(this).closest('tr').remove();
      }
    });

    // Duplicate handler
    $(document).on('click', '.duplicate-row', function(){
      const idx = $('#selection-table tbody tr.selection-row').index($(this).closest('tr'));
      cloneRow(idx);
    });

    // Helper to clone row. if idx < 0, clone last; else clone at idx
function cloneRow(idx){
  const rows = $('#selection-table tbody tr.selection-row');
  const source = idx < 0 ? rows.last() : rows.eq(idx);
  const $clone = source.clone(false);
  const newIndex = $('#selection-table tbody tr.selection-row').length;

  // Reset inputs
  $clone.find('.commodity-input').val('');
  $clone.find('.destination-select').html('<option value="">--Select Destination--</option>');
  $clone.find('input[type="date"]').val('');
  $clone.find('input[type="radio"]').each(function(){
    const $r = $(this);
    $r.attr('name', 'direction_' + newIndex)
      .prop('checked', $r.val() === 'Buy');
  });

  // 移除了重复的事件绑定代码

  $clone.addClass('selection-row');
  $('#selection-table tbody').append($clone);
}

    // Commodity -> Destination cascade
    $(document).on('input', '.commodity-input', function(){
      const $row = $(this).closest('tr');
      const comm = $(this).val();
      const $dest = $row.find('.destination-select');
      $dest.html('<option value="">--Select Destination--</option>');
      if(!comm) return;
      fetch('/get_destinations',{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({commodity:comm})
      }).then(r=>r.json()).then(list=>{
        list.forEach(d=> $dest.append(`<option value="${d}">${d}</option>`));
      });
    });

    // Destination -> Commodity validation
    $(document).on('change', '.destination-select', function(){
      const $row = $(this).closest('tr');
      const dest = $(this).val();
      const $comm = $row.find('.commodity-input');
      if(!dest) return;
      fetch('/get_commodities',{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({destination:dest})
      }).then(r=>r.json()).then(list=>{
        if(!list.includes($comm.val())) $comm.val('');
      });
    });

    // Fetch Curve Roots
    $('#fetch-btn').on('click', function(){
      $('#results-container').empty();
      $('#selection-table tbody tr.selection-row').each(function(i,tr){
        const $tr = $(tr);
        const comm = $tr.find('.commodity-input').val();
        const dest = $tr.find('.destination-select').val();
        const dir = $tr.find(`input[name="direction_${i}"]:checked`).val();
        fetch('/get_curve_root',{
          method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({commodity:comm,destination:dest})
        }).then(r=>r.json()).then(data=>{
          $('#results-container').append(
            `<p>Row ${i+1}: ${comm}-${dest} → ${data.curve_root} (${dir})</p>`
          );
        });
      });
    });
  });
  </script>
</body>
</html>